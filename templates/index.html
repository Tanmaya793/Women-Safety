<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Webpage</title>
    <style>
        body {
            display: flex;
            height: 100vh;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(to right, #f7f7f7, #d0e6f0);
            color: #333;
            transition: background 0.3s ease;
        }
        .sidebar {
            width: 25%;
            background-color: #1e2a38;
            color: #f0f0f0;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .main-content {
            width: 75%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .video-container {
            width: 100%;
            height: 65%;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }
        .empty-space {
            width: 100%;
            height: 35%;
            background-color: #2c3e50;
            border-radius: 15px;
            color: #ecf0f1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            box-sizing: border-box;
            text-align: center;
            font-size: 20px;
        }
        .video-wrapper {
            position: relative;
            width: 90%;
            margin-bottom: 15px;
            cursor: pointer;
        }
        .camera-video {
            width: 100%;
            border: 2px solid #34495e;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .camera-video:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }
        .camera-text {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #ecf0f1;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 10;
            pointer-events: none;
        }
        hr {
            width: 100%;
            border: 0;
            height: 1px;
            background: linear-gradient(to right, rgba(255,255,255,0), rgba(255,255,255,0.5), rgba(255,255,255,0));
            margin: 20px 0;
        }
        .gender-stats {
            font-size: 22px;
            font-weight: bold;
        }
        .gender-stats p {
            margin: 10px 0;
            color: #ecf0f1;
        }
        .male-icon::before {
            content: "♂️";
            margin-right: 10px;
            color: #3498db;
        }
        .female-icon::before {
            content: "♀️";
            margin-right: 10px;
            color: #e74c3c;
        }
        .gender-stats span {
            font-size: 24px;
        }
        .gender-stats #ratio {
            color: #2ecc71;
        }
        .risk-alert {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            display: none;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="video-wrapper" onclick="showFullCamera('camera1')">
            <img src="{{ url_for('video_feed') }}" id="camera1" class="camera-video" alt="Video Feed">
            <div class="camera-text">Camera 1<span id="c1"></span></div>
        </div>
        <div class="video-wrapper" onclick="showFullCamera('camera2')">
            <video id="camera2" class="camera-video" autoplay muted></video>
            <div class="camera-text">Camera 2</div>
        </div>
        <div class="video-wrapper" onclick="showFullCamera('camera3')">
            <video id="camera3" class="camera-video" autoplay muted></video>
            <div class="camera-text">Camera 3</div>
        </div>
        <div class="video-wrapper" onclick="showFullCamera('camera4')">
            <video id="camera4" class="camera-video" autoplay muted></video>
            <div class="camera-text">Camera 4</div>
        </div>
    </div>
    <div class="main-content">
        <span id="datetime"></span>
        <div class="video-container" id="video-container">
            <p style="color: #ecf0f1; font-size: 26px; font-weight: bold;">Click on a camera to view the video</p>
        </div>
        <hr>
        <div class="empty-space">
            <div id="gender-counts" class="gender-stats">
                <p><span class="male-icon">Men:</span> <span id="male-count">0</span></p>
                <p><span class="female-icon">Women:</span> <span id="female-count">0</span></p>
                <p>Ratio (Women/Men): <span id="ratio">N/A</span></p>
                <p>Women Minimum Age: <span id="minage"></span></p>
                <p>Women Maximum Age: <span id="maxage"></span></p>
                <p id="risk-alert" class="risk-alert">Risk Detected! The ratio is too low.</p>
            </div>
        </div>
    </div>
    <script>
        let riskTimer = null;
        let riskDuration = 5000; // 10 seconds
        let ratioThresholdLow = 0.001;
        let ratioThresholdHigh = 0.5;

        function updateBackgroundColor(color) {
            document.body.style.background = color;
        }

        function showRiskAlert() {
            document.getElementById('risk-alert').style.display = 'block';
        }

        let audioContext;

        function initializeAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playBeep() {
            initializeAudioContext();
            const oscillator = audioContext.createOscillator();
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            oscillator.connect(audioContext.destination);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 10);
        }

        function showAlertMessage() {
            alert('Risk Detected! The ratio is too low.');
        }

        function triggerRiskAlert() {
            updateBackgroundColor('#ff4c4c');
            showRiskAlert();
            playBeep();
            showAlertMessage();
        }

        function resetRiskAlert() {
            updateBackgroundColor('linear-gradient(to right, #f7f7f7, #d0e6f0)');
            document.getElementById('risk-alert').style.display = 'none';
        }

        function handleRiskCheck(ratio,minage,maxage) {
            if (ratio > ratioThresholdLow && ratio < ratioThresholdHigh && (minage < 27 || maxage > 40 )) {
                if (!riskTimer) {
                    riskTimer = setTimeout(triggerRiskAlert, riskDuration);
                }
            } else {
                if (riskTimer) {
                    clearTimeout(riskTimer);
                    riskTimer = null;
                    resetRiskAlert();
                }
            }
        }

        function updateGenderCount() {
            fetch('/gender_count')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('male-count').textContent = data.Men;
                    document.getElementById('female-count').textContent = data.Women;
                    document.getElementById('ratio').textContent = data.Ratio;
                    document.getElementById('minage').textContent = data.Min_Women;
                    document.getElementById('maxage').textContent = data.Max_Women;

                    const ratio = parseFloat(data.Ratio);
                    handleRiskCheck(ratio);
                })
                .catch(error => console.error('Error fetching gender count:', error));
        }

        function showFullCamera(cameraId) {
            const videoContainer = document.getElementById('video-container');
            const videoElement = document.getElementById(cameraId);
            const fullViewVideo = videoElement.cloneNode(true);
            fullViewVideo.autoplay = true;
            fullViewVideo.muted = true;
            fullViewVideo.controls = true;
            fullViewVideo.style.width = '100%';
            fullViewVideo.style.height = '100%';
            videoContainer.innerHTML = '';
            videoContainer.appendChild(fullViewVideo);
        }

        async function setupCamera(videoElementId) {
            const video = document.getElementById(videoElementId);
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "user" },
                audio: true
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
            }
        }

        function startAllCameras() {
            setupCamera('camera2');
            setupCamera('camera3');
            setupCamera('camera4');
        }

        window.onload = () => {
            startAllCameras();
            setInterval(updateGenderCount, 1000); // Update gender counts every second
        };


        function updateDateTime() {
        const now = new Date();
        const options = {  year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
        const formattedDateTime = now.toLocaleDateString('en-US', options);
        document.getElementById('datetime').textContent = formattedDateTime;
    }
    setInterval(updateDateTime, 1000);                
    updateDateTime();    

    </script>
</body>
</html>
